#!/usr/bin/env sh
#MISE description="Process bash startup profiling logs and generate timing reports"

LOG_FILE="$HOME/.local/share/dotfiles/bash/profile_timing.log"

# Check if the source log file exists
if [ ! -f "$LOG_FILE" ]; then
    echo "ERROR: Bash profile timing log not found at $LOG_FILE"
    echo "To generate this log, you need to add profiling instrumentation to your bash startup files."
    echo ""
    echo "The profile_source function is already defined in ~/.bashrc."
    echo "It automatically profiles when BASH_PROFILE_TIMING=1 is set."
    echo ""
    echo "To profile your bash startup:"
    echo "BASH_PROFILE_TIMING=1 bash -l"
    exit 1
fi

SCRIPTS_DIR="$HOME/.config/mise/scripts"

if [ ! -f "$SCRIPTS_DIR/log_to_csv.awk" ] || [ ! -f "$SCRIPTS_DIR/csv_summary.awk" ]; then
    echo "ERROR: Required AWK scripts not found in $SCRIPTS_DIR"
    echo "Expected files:"
    echo "  - $SCRIPTS_DIR/log_to_csv.awk"
    echo "  - $SCRIPTS_DIR/csv_summary.awk"
    exit 1
fi

echo "Processing bash startup timing log..."

# Pipeline: log -> CSV -> summary (output to stdout)
echo ""
echo "=== Bash Startup Timing Summary ==="
awk -f "$SCRIPTS_DIR/log_to_csv.awk" "$LOG_FILE" | awk -f "$SCRIPTS_DIR/csv_summary.awk"
